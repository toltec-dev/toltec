#!/usr/bin/env bash
# Copyright (c) 2021 The Toltec Contributors
# SPDX-License-Identifier: MIT

pkgnames=(erode fret oxide rot tarnish decay)
pkgver=2.1.2-2
timestamp=2021-01-07T03:28Z
maintainer="Eeems <eeems@eeems.email>"
license=MIT
makedepends=(build:patchelf)
flags=(nostrip)

image=qt:v1.4
source=("https://github.com/Eeems/oxide/archive/v${pkgver%-*}.tar.gz")
sha256sums=(1a6c97ec8c836a9491d3f943d4034132d96b488fd773de3a75b789e2e028aa58)

build() {
    find . -name "*.pro" -type f -print0 \
        | xargs -0 sed -i 's/linux-oe-g++/linux-arm-remarkable-g++/g'
    make release

    # Inject rm2fb shim
    # (after running strip, otherwise strip removes too much information)
    for bin in release/opt/bin/{erode,fret,oxide,decay}; do
        "${CROSS_COMPILE}strip" --strip-all "$bin"
        patchelf --add-needed librm2fb_client.so "$bin"
    done
}

erode() {
    pkgdesc="Task manager"
    url=https://github.com/Eeems/oxide/tree/master/applications/process-manager
    section="admin"
    installdepends=(display rm2fb-shim "tarnish=$pkgver")

    package() {
        install -D -m 755 -t "$pkgdir"/opt/bin "$srcdir"/release/opt/bin/erode
        install -D -m 644 -t "$pkgdir"/opt/usr/share/applications "$srcdir"/release/opt/usr/share/applications/codes.eeems.erode.oxide
    }
}

fret() {
    pkgdesc="Take screenshots"
    url=https://github.com/Eeems/oxide/tree/master/applications/screenshot-tool
    section="utils"
    installdepends=(display rm2fb-shim "tarnish=$pkgver")

    package() {
        install -D -m 755 -t "$pkgdir"/opt/bin "$srcdir"/release/opt/bin/fret
        install -D -m 644 -t "$pkgdir"/opt/usr/share/applications "$srcdir"/release/opt/usr/share/applications/codes.eeems.fret.oxide
    }
}

oxide() {
    pkgdesc="Launcher application"
    url=https://github.com/Eeems/oxide/tree/master/applications/launcher
    section="launchers"
    installdepends=(display rm2fb-shim "erode=$pkgver" "fret=$pkgver" "tarnish=$pkgver" "rot=$pkgver" "decay=$pkgver")

    package() {
        install -D -m 755 -t "$pkgdir"/opt/bin "$srcdir"/release/opt/bin/oxide
        install -D -m 644 -t "$pkgdir"/opt/etc "$srcdir"/release/opt/etc/oxide.conf
        install -D -m 644 -t "$pkgdir"/opt/usr/share/applications "$srcdir"/release/opt/usr/share/applications/codes.eeems.oxide.oxide
    }
    configure() {
        if ! is-enabled "tarnish.service"; then
            echo ""
            echo "Run the following command(s) to use $pkgname as your launcher"
            how-to-enable "tarnish.service"
            echo ""
        fi
    }
}

rot() {
    pkgdesc="Manage Oxide settings through the command line"
    url=https://github.com/Eeems/oxide/tree/master/applications/settings-manager
    section="admin"
    installdepends=("tarnish=$pkgver")

    package() {
        install -D -m 755 -t "$pkgdir"/opt/bin "$srcdir"/release/opt/bin/rot
    }
}

tarnish() {
    pkgdesc="Service managing power states, connectivity and buttons"
    url=https://github.com/Eeems/oxide/tree/master/applications/system-service
    section="devel"
    installdepends=(xochitl)

    package() {
        install -D -m 644 -t "$pkgdir"/etc/dbus-1/system.d "$srcdir"/release/etc/dbus-1/system.d/codes.eeems.oxide.conf
        install -D -m 644 -t "$pkgdir"/lib/systemd/system "$srcdir"/release/etc/systemd/system/tarnish.service
        install -D -m 755 -t "$pkgdir"/opt/bin "$srcdir"/release/opt/bin/tarnish
    }
    configure() {
        systemctl daemon-reload
    }
    preremove() {
        if is-active tarnish; then
            echo "Stopping tarnish"
            systemctl stop tarnish
        fi
        if is-enabled tarnish; then
            echo "Disabling tarnish"
            systemctl disable tarnish
        fi
    }
    postremove() {
        systemctl daemon-reload
    }
}

decay() {
    pkgdesc="Lockscreen application"
    url=https://github.com/Eeems/oxide/tree/master/applications/lockscreen
    section="utils"
    installdepends=(display rm2fb-shim "tarnish=$pkgver")

    package() {
        install -D -m 755 -t "$pkgdir"/opt/bin "$srcdir"/release/opt/bin/decay
        install -D -m 644 -t "$pkgdir"/opt/usr/share/applications "$srcdir"/release/opt/usr/share/applications/codes.eeems.decay.oxide
    }
}
